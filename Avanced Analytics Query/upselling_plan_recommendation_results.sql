SELECT 
IN_ACCOUNT_NUMBER,
'upselling_plan_recommendation_results' AS MODEL_NAME,
date_dt AS LAST_MODEL_REFRESH_DATE,
STEP_UP_PLAN_NAME AS AD_ATTRIBUTE_11,
CASE WHEN STEP_UP_PLAN_CHANGE_VALUE_LESS_THAN_SPENT_CHANGE_FLAG=1 THEN TRUNC(ABS(STEP_UP_PLAN_PRICE_CHANGE)) || ' More'  
WHEN STEP_UP_PLAN_CHANGE_VALUE_LESS_THAN_SPENT_CHANGE_FLAG=0 THEN TRUNC(ABS(STEP_UP_PLAN_PRICE_VS_SPENT_CHANGE),0) || ' More'  
END AS AD_ATTRIBUTE_12,
STEP_UP_CURRENT_PLAN_PRICE AS AD_ATTRIBUTE_31,
STEP_UP_PLAN_DATA_CHANGE AS AD_ATTRIBUTE_32,
STEP_UP_PLAN_INTL_MIN_CHANGE AS AD_ATTRIBUTE_33,
STEP_UP_PLAN_PRICE AS AD_ATTRIBUTE_34,
STEP_UP_PLAN_PRICE_CHANGE AS AD_ATTRIBUTE_35,
STEP_UP_AVG_MONEY_SPENT_60D AS AD_ATTRIBUTE_36,
STEP_UP_PLAN_NATIONAL_MIN_CHANGE AS AD_ATTRIBUTE_37,
STEP_UP_AS_PRC_OF_PLAN AS AD_ATTRIBUTE_38,
STEP_UP_PLAN_PRICE_VS_SPENT_CHANGE AS AD_ATTRIBUTE_39,
STEP_UP_AS_PRC_OF_SPENT AS AD_ATTRIBUTE_40,
STEP_UP_PLAN_CHANGE_VALUE_LESS_THAN_SPENT_CHANGE_FLAG AD_ATTRIBUTE_41
FROM(
SELECT *,
TRUNC(STEP_UP_PLAN_PRICE_VS_SPENT_CHANGE / STEP_UP_AVG_MONEY_SPENT_60D,2)  AS STEP_UP_AS_PRC_OF_SPENT,
CASE WHEN STEP_UP_PLAN_PRICE_CHANGE IS NULL OR STEP_UP_PLAN_PRICE_VS_SPENT_CHANGE IS NULL THEN 2 
WHEN STEP_UP_PLAN_PRICE_VS_SPENT_CHANGE>=STEP_UP_PLAN_PRICE_CHANGE THEN 1 ELSE 0 END  AS STEP_UP_PLAN_CHANGE_VALUE_LESS_THAN_SPENT_CHANGE_FLAG
FROM(
SELECT 
in_account_number AS IN_ACCOUNT_NUMBER,
date_dt ,
step_up_plan_name AS  STEP_UP_PLAN_NAME,
current_plan_net_cost AS STEP_UP_CURRENT_PLAN_PRICE,
step_up_plan_data_change AS STEP_UP_PLAN_DATA_CHANGE,
step_up_plan_intl_min_change AS STEP_UP_PLAN_INTL_MIN_CHANGE,
step_up_plan_price AS STEP_UP_PLAN_PRICE,
TRUNC(step_up_plan_price_change,2) AS STEP_UP_PLAN_PRICE_CHANGE,
\"60day_avg_money_spent\" AS STEP_UP_AVG_MONEY_SPENT_60D,
step_up_plan_national_min_change AS STEP_UP_PLAN_NATIONAL_MIN_CHANGE,
TRUNC(step_up_plan_price_change/current_plan_net_cost,2) AS STEP_UP_AS_PRC_OF_PLAN,
TRUNC(step_up_spent_change,2)  AS STEP_UP_PLAN_PRICE_VS_SPENT_CHANGE
FROM(
SELECT 
*,
ROW_NUMBER() OVER (PARTITION BY in_account_number) AS IN_RANK
FROM(
SELECT 
*,
RANK() OVER (ORDER BY date_dt DESC) AS STEP_UP_LAST_DATE_FLAG
FROM neocognix.cr_upselling_plan_recommendation_results
WHERE date_dt < date('"+context.vLoadDate+"')
)STEP_UP_LAST_DATE
WHERE STEP_UP_LAST_DATE_FLAG=1 
)UNI_IN WHERE IN_RANK=1
)A
)B;